<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="assets/design.css">
  <link rel="stylesheet" href="assets/style-off.css" id="bodyStyle">
  <script src="/assets/control.js"></script>
  <script src="assets/bundle.js"></script>
  <title>BlueBerryPi</title>
</head>

<body>
  <header>
    <h1>
      Blueberry Pi
    </h1>
  </header>
  <div id="camera">
    Live streaming
  </div>
  <div id="music">
    <div id="music-front">
      <p class="turnBoxButton">祭りモードOFF</p>
    </div>
    <div>
      <p class="turnBoxButton turnBoxButtonPrev">祭りモードON</p>
    </div>
  </div>
  <div id="container">
    <div id="up">
      <div id="up-front">
        <p class="turnBoxButton">Forward</p>
      </div>
      <div>
        <p class="turnBoxButton">Pressed</p>
      </div>
    </div>
    <div id="left">
      <div id="left-front">
        <p class="turnBoxButton">Left</p>
      </div>
      <div>
        <p class="turnBoxButton">Pressed</p>
      </div>
    </div>
    <div id="right">
      <div id="right-front">
        <p class="turnBoxButton">Right</p>
      </div>
      <div>
        <p class="turnBoxButton">Pressed</p>
      </div>
    </div>
    <div id="down">
      <div id="down-front">
        <p class="turnBoxButton">Backward</p>
      </div>
      <div>
        <p class="turnBoxButton">Pressed</p>
      </div>
    </div>
  </div>
  <script>
    "use strict";
    const forwardAudio = new Audio("assets/oisho.mp3");
    forwardAudio.loop = true;
    //const rightAudio = new Audio("assets/.mp3");
    //rightAudio.loop = true;
    //const leftAudio = new Audio("assets/.mp3");
    //leftAudio.loop = true;
    const backwardAudio = new Audio("assets/oisho_rev.mp3");
    backwardAudio.loop = true;
    $("#up").turnBox({
      duration: 50,
      perspective: 400,
      direction: "negative"
    });
    $("#left").turnBox({
      duration: 50,
      axis: "Y",
    });
    $("#right").turnBox({
      duration: 50,
      axis: "Y",
      direction: "negative"
    });
    $("#down").turnBox({
      duration: 50,
      direction: "positive"
    });
    $("#music").turnBox({
      duration: 50
    });

    let inMatsuri = false;
    $("#music").on("click", function () {
      if (inMatsuri) {
        inMatsuri = false;
        //alert("祭りは終わりだ......");
        document.getElementById('bodyStyle').href = "assets/style-off.css";
      } else {
        inMatsuri = true;
        //alert("浜松祭りだ!!");
        document.getElementById('bodyStyle').href = "assets/style-on.css";
      }
    });

    class BtnCfg {
      constructor(button, music, command, key) {
        this.button = button;
        this.music = music;
        this.command = command;
        this.key = key;
      }
    }
    const buttons = [
      new BtnCfg(document.getElementById("up"), forwardAudio, "forward", "w"),
      new BtnCfg(document.getElementById("right"), null, "right", "d"),
      new BtnCfg(document.getElementById("left") , null, "left", "a"),
      new BtnCfg(document.getElementById("down") , backwardAudio, "backward", "s")
    ]

    // generate event handler for control buttons pressed
    function genCtrlBtnPressEventHandler(music, cmd) {
      return function(e) {
        e.preventDefault();
        $(this).turnBoxAnimate({
          face: 2,
          animation: true
        });
        if (music !== null && inMatsuri) {
          music.play();
        }
        req(cmd);
      }
    }

    // generate event handler for control buttons released
    function genCtrlBtnReleaseEventHandler(music) {
      return function(e) {
        e.preventDefault();
        $(this).turnBoxAnimate({
          face: 1,
          animation: true
        });
        if (music !== null) {
          music.pause();
          music.currentTime = 0;
        }
        req("stop");
      }
    }

    let pressedKey = null;
    document.addEventListener(
      "keydown",
      (e) => {
        if (e.repeat) {
          return;
        }
        const k = e.key;
        for (const b of buttons) {
          if (b.key == k && pressedKey === null) {
            e.preventDefault();
            pressedKey = k;
            b.button.dispatchEvent(new MouseEvent("mousedown"));
          }
        }
      }
    );

    document.addEventListener(
      "keyup",
      (e) => {
        const k = e.key;
        for(const b of buttons) {
          if (b.key == k && pressedKey == k) {
            e.preventDefault();
            pressedKey = null;
            b.button.dispatchEvent(new MouseEvent("mouseup"));
          }
        }
      }
    );

    for (const e of buttons) {
      const b = e.button;
      if (b.addEventListener) {
        const press = genCtrlBtnPressEventHandler(e.music, e.command);
        const release = genCtrlBtnReleaseEventHandler(e.music);
        b.addEventListener("mousedown", press);
        b.addEventListener("mouseup", release);
        b.addEventListener("touchstart", press);
        b.addEventListener("touchend", release);
      }
    }
  </script>
</body>

</html>
